var ExpApp,PageModel;(function(n){function t(t,u){this.element=t;this.options=n.extend({},r,u);this._defaults=r;this._name=i;this.init()}var i="Presets",r={startPreset:0,buttonNext:'<div class="left carousel-control">&rsaquo;<\/div>',buttonPrev:'<div class="right carousel-control">&lsaquo;<\/div>'};t.prototype.init=function(){var t=this,i=n(t.element);t.findSelected();i.find(".item").size()>3?t.initCarousel():t.initList()};t.prototype.findSelected=function(){var t=this,i=n(t.element).find(".item .selected");i.length&&(t.options.startPreset=i.parent().index())};t.prototype.initCarousel=function(){var t=this,i=n(t.element),r;i.length&&n(t.element).jcarousel({scroll:1,start:t.options.startPreset,wrap:"circular",buttonNextHTML:t.options.buttonNext,buttonPrevHTML:t.options.buttonPrev,itemVisibleInCallback:{onBeforeAnimation:function(t,r){var u=n(r).prev().prev().hasClass("active");i.find(".item").removeClass("active");u?n(r).prev().addClass("active"):n(r).next().addClass("active")}}});i.find(".item").removeClass("active");r=i.find(".item[jcarouselindex="+(t.options.startPreset+1)+"]");r.addClass("active");r.children().addClass("selected");n(t.element).find(".item-inner").click(function(){var t=n(this).parent(),i=n(this),r=t.next().hasClass("active"),u=t.prev().hasClass("active");r&&n(".right.carousel-control").click();u&&n(".left.carousel-control").click();n(".item-inner").removeClass("selected");i.addClass("selected")})};t.prototype.initList=function(){var t=this,r=n(t.element),i;r.addClass("presets-list");i=r.children().eq(t.options.startPreset);i.addClass("active");i.children().addClass("selected");n(t.element).find(".item-inner").click(function(){var t=n(this).parent(),i=n(this);n(".item-inner").removeClass("selected");n(".item").removeClass("active");t.addClass("active");i.addClass("selected")})};n.fn[i]=function(r){return this.each(function(){n.data(this,"plugin_"+i)||n.data(this,"plugin_"+i,new t(this,r))})}})(jQuery,window,document),function(n,t){function i(t,i){this.element=t;this.options=n.extend({},u,i);this.system=f;this._defaults=u;this._name=r;this.init()}var r="MapProvider",u={provider:null,key:null,latitude:null,longitude:null,latitudeVal:8,longitudeVal:8,draggable:!1},f={latitudeReg:/^-?(?:90(?:(?:\.0{1,6})?)|(?:[0-9]|[1-8][0-9])(?:(?:\.[0-9]{1,6})?))$/i,longitudeReg:/^-?(?:180(?:(?:\.0{1,6})?)|(?:[0-9]|[1-9][0-9]|1[1-7][0-9])(?:(?:\.[0-9]{1,6})?))$/i};i.prototype.init=function(){var n=this;n.SetOptions();switch(n.options.provider){case"Google":n.RenderGoogleMaps();break;case"Bing":n.RenderBingMaps();break;default:return}};i.prototype.RenderBingMaps=function(){var n=this,r=new Microsoft.Maps.Map(n.element,{credentials:n.options.key,enableSearchLogo:!1,showDashboard:!1,showScalebar:!1,center:new Microsoft.Maps.Location(n.options.latitudeVal,n.options.longitudeVal),mapTypeId:Microsoft.Maps.MapTypeId.road,zoom:10}),u,i;r.entities.clear();u={draggable:n.options.draggable};i=new Microsoft.Maps.Pushpin(r.getCenter(),u);r.entities.push(i);i.setLocation(new Microsoft.Maps.Location(n.options.latitudeVal,n.options.longitudeVal));n.options.draggable&&(Microsoft.Maps.Events.addHandler(r,"mousedown",function(n){t.positionDown=new Microsoft.Maps.Point(n.getX(),n.getY())}),Microsoft.Maps.Events.addHandler(r,"mouseup",function(r){var f=new Microsoft.Maps.Point(r.getX(),r.getY()),e,u;t.positionDown.x==f.x&&t.positionDown.y==f.y&&(e=new Microsoft.Maps.Point(r.getX(),r.getY()),u=r.target.tryPixelToLocation(e),i.setLocation(u),n.options.latitude.val(u.latitude),n.options.longitude.val(u.longitude))}),Microsoft.Maps.Events.addHandler(i,"drag",function(){var t=i.getLocation();i.setLocation(t);n.options.latitude.val(t.latitude);n.options.longitude.val(t.longitude)}));n.options.latitude.keyup(function(){var t=n.options.latitude.val(),u=n.options.longitude.val();n.system.latitudeReg.test(t)&&(i.setLocation(new Microsoft.Maps.Location(t,u)),r.setView({center:new Microsoft.Maps.Location(t,u)}))});n.options.longitude.keyup(function(){var u=n.options.latitude.val(),t=n.options.longitude.val();n.system.longitudeReg.test(t)&&(i.setLocation(new Microsoft.Maps.Location(u,t)),r.setView({center:new Microsoft.Maps.Location(u,t)}))})};i.prototype.RenderGoogleMaps=function(){var n=this,i;latLng=new t.google.maps.LatLng(n.options.latitudeVal,n.options.longitudeVal);i={zoom:10,center:latLng,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(n.element,i);marker=new google.maps.Marker({position:latLng,map:map,draggable:n.options.draggable});n.options.draggable&&(google.maps.event.addListener(map,"click",function(t){marker.setPosition(t.latLng);n.options.latitude.val(t.latLng.lat().toFixed(6));n.options.longitude.val(t.latLng.lng().toFixed(6))}),google.maps.event.addListener(t.marker,"drag",function(){n.options.latitude.val(marker.position.lat().toFixed(6));n.options.longitude.val(marker.position.lng().toFixed(6))}));n.options.latitude.keyup(function(){var r=n.options.latitude.val(),u=n.options.longitude.val(),i;n.system.latitudeReg.test(r)&&(i=new t.google.maps.LatLng(r,u),t.marker.setPosition(i),map.setCenter(i))});n.options.longitude.keyup(function(){var u=n.options.latitude.val(),r=n.options.longitude.val(),i;n.system.longitudeReg.test(r)&&(i=new t.google.maps.LatLng(u,r),t.marker.setPosition(i),map.setCenter(i))})};i.prototype.SetOptions=function(){var t=this;t.options.provider=n(t.element).data("name");t.options.draggable=n(t.element).data("draggable");t.options.key=n(t.element).data("api-key");t.options.latitudeVal=t.options.latitude.val();t.options.longitudeVal=t.options.longitude.val()};n.fn[r]=function(t){return this.each(function(){n.data(this,"plugin_"+r)||n.data(this,"plugin_"+r,new i(this,t))})}}(jQuery,window,document),function(n,t){function i(t,i){this.element=t;this.options=n.extend({},u,i);this._defaults=u;this._name=r;this.init()}var r="GeoIp",u={testLink:"#link_testgeo",switcherLinks:"a[data-toggle='geo-type']",switcherData:".geo-ip-data"};i.prototype.init=function(){var n=this;n.TestIp();n.SwitchSubTabs()};i.prototype.TestIp=function(){var f=this,i=n(f.options.testLink),r=n(i.attr("href")),u=n("<img>").attr("src","/sitecore modules/web/experienceExplorer/assets/images/loading.gif");i.append(u.hide());i.click(function(){u.show();var i=n("input[name=__RequestVerificationToken]",t.parent.document).val();return jQuery.ajax({url:"/sitecore/api/ssc/experienceexplorer/updateservice/model/geoiptest",type:"GET",contentType:"application/json",headers:{"X-RequestVerificationToken":i}}).success(function(t){var f,i;r.empty();var f="",e=n("<p>").text(t.Message),o=n("<img>").prop("src",t.IconPath),s=n('<a href="#">').attr("title",t.QuestionMark).attr("data-toggle","tooltip").attr("data-placement","left").addClass("info hide").text("?");t.Description!=null&&(f=n("<div>").html(t.Description));e.prepend(o);r.append(s).append(e).append(f);i=n("[data-toggle=tooltip]");i.length&&i.tooltip();r.slideDown();u.hide()}),!1})};i.prototype.SwitchSubTabs=function(){var t=this,i=n(t.options.switcherLinks),r=n(t.options.switcherData),u=t.GetDefaultSubTab(),f=n(u),e=n("[data-source="+u+"]");f.removeClass("collpase-geo");e.addClass("active");i.click(function(){var t=n(this),u=t.attr("data-source"),f=n(u);return n.cookie("geo-subtab",u),i.removeClass("active"),t.addClass("active"),r.slideUp("fast"),r.addClass("collpase-geo"),f.slideDown("fast"),f.removeClass("collpase-geo"),!1})};i.prototype.GetDefaultSubTab=function(){var i=this,t=n.cookie("geo-subtab");return t!=""&&typeof t!="undefined"?t:"#"+n(i.options.switcherData).first().attr("id")};n.fn[r]=function(t){return this.each(function(){n.data(this,"plugin_"+r)||n.data(this,"plugin_"+r,new i(this,t))})}}(jQuery,window,document),function(n){function i(i,u){this.element=i;this.options=n.extend({},r,u);this._defaults=r;this._name=t;this.init()}var t="Rules",r={title:".conditions-title"};i.prototype.init=function(){var n=this;n.InitTooltips()};i.prototype.InitTooltips=function(){var i=this,t=n(i.element),r=t.next(i.options.title).html();t.attr("title",r);t.tooltip({placement:"top"})};n.fn[t]=function(r){return this.each(function(){n.data(this,"plugin_"+t)||n.data(this,"plugin_"+t,new i(this,r))})}}(jQuery,window,document);ExpApp=function(){var n=this;n.model={};n.getModel=function(){jQuery.getJSON("/eeapi/experienceexplorer/get",function(t){n.model=t;n.bindModel()})};n.updateModel=function(){function r(n,t){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+n+"=([^&#]*)"),i=r.exec(t);return i==null?"":decodeURIComponent(i[1].replace(/\+/g," "))}var t,i;n.model.PresetId==undefined&&(t=r("presetId",location.search),n.model.PresetId=t);i=$("input[name=__RequestVerificationToken]",window.parent.document).val();jQuery.ajax({url:"/sitecore/api/ssc/experienceexplorer/updateservice/model/update",type:"POST",contentType:"application/json",data:JSON.stringify(n.model),headers:{"X-RequestVerificationToken":i}}).success(function(){console.log("update model: done");window.parent.location.reload()}).fail(function(n){alert(n.responseJSON.ExceptionMessage);var t=jQuery("#btn_apply");t.removeAttr("disabled");t.html(SettingsPanelTranslations.applyText)})}},function(n,t,i,r){function u(t,i){this.element=t;this.options=n.extend({},e,i);this._defaults=e;this._name=f;this.init()}n(i).ready(function(){n("#accordions-editor").DataPresentation();n("#accordions-viewer").DataPresentation();n(".trigger").click()});var f="DataPresentation",e={id:null,tabLinks:"a[data-toggle=tab]",tabContent:".tab-content",accordionGroup:".accordion-group",accordionLinks:"a[data-toggle=collapse]",accordionItem:".accordion-body"};u.prototype.init=function(){var i=this,f=n(i.options.tabLinks),e=n(i.options.accordionLinks),r=i.GetCookieId(),u=n('[href="'+r+'"]'),o=u.closest(i.options.accordionGroup);e.click(function(){var u=n(this),t=u.closest(i.options.accordionGroup),r=t.find(i.options.accordionItem);return r.css("display")=="none"?i.ShowAccordion(t):(t.parent().find(".sc-advancedExpander-header").removeClass("activeAccordion"),t.parent().find(".sc-expander-chevron").removeClass("up"),r.slideUp("fast")),!1});f.click(function(){var r=n(i.element).attr("id"),t=n(this).attr("href");return i.id=t.replace("#",""),n.cookie(r,t),n(t).html().length==0&&i.GetAjaxData(),i.ShowTab(t),!1});i.id=r;i.ShowAccordion(o,u);n(t).resize(function(){i.SetSize(i.id)})};u.prototype.ShowAccordion=function(t,i){var r=this,o=n(r.options.accordionItem),u=t.find(r.options.accordionItem),f,e;i?i.click():u.find(".nav-tabs a:first").click();t.parent().find(".sc-expander-chevron").removeClass("up");f=t.find(".sc-expander-chevron");f.addClass(" up");o.slideUp("fast");u.slideDown("fast");t.parent().find(".sc-advancedExpander-header").removeClass("activeAccordion");e=t.find(".sc-advancedExpander-header");e.addClass("activeAccordion")};u.prototype.ShowTab=function(t){var o=this,f=n("[href="+t+"]").parent(),s=f.siblings(),i=n(t),h=i.siblings(),e=i.parent(),c=n(o.options.tabContent),r,u;s.removeClass("active");f.addClass("active");c.removeClass("active");h.hide();e.addClass("active");i.fadeIn("fast");r=i.data("input-model-name");exp&&r&&(exp.model[r]="");u=e.parent().find(".sc-tabcontrol-navigation");u.children().length==1&&u.hide()};u.prototype.GetUrlParameter=function(n,t){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+n+"=([^&#]*)"),i=r.exec(t);return i==null?"":decodeURIComponent(i[1].replace(/\+/g," "))};u.prototype.GetAjaxData=function(){var i=this,r=u.prototype.GetUrlParameter("itemUri",location.search),f=u.prototype.GetUrlParameter("deviceId",location.search),e=u.prototype.GetUrlParameter("visitPageCount",location.search),o=n("input[name=__RequestVerificationToken]",t.parent.document).val();n.ajax({url:"/sitecore/api/ssc/experienceexplorer/contentservice/content/getcontent/?controlId="+i.id+"&deviceId="+f+"&itemUri="+encodeURIComponent(r)+"&visitPageCount="+e,type:"GET",dataType:"json",contentType:"application/json",headers:{"X-RequestVerificationToken":o}}).success(function(t){if(i.id!=null){var r=n.templates("#"+i.id+"_view"),u={itemData:{Source:t}};r.link("#"+i.id,u)}i.RunPlugins()}).done(function(){i.SetSize(i.id)})};u.prototype.SetSize=function(i){var f=this,u=0,e=n(t).height(),r=n(".footer-panel").outerHeight();r+=n("#frame-header").outerHeight();n(".accordion-heading").each(function(){r+=n(this).height()});u=e-r-160;n("#"+i).closest(".tab-content").css("max-height",u);f.InitTexts();n(".tab-title:empty").hide();n(".tab-title:empty").parent().find("a.info").css("margin-top","0")};u.prototype.InitTexts=function(){var i=n("#litEditorSpan"),r=t.top.$("#pageEditorHeader");r.html(i.parent().html())};u.prototype.GetCookieId=function(){var i=this,u=n(i.element).attr("id"),t=n.cookie(u),f=n(i.options.tabLinks);return t===r&&(t=f.first().attr("href")),t};u.prototype.RunPlugins=function(){var h=this,t=n("[data-toggle=tooltip]"),i=n(".conditions[data-toggle=tooltip]"),r=n("[data-toggle=goals-autocomplete]"),u=n("[data-toggle=campaigns-autocomplete]"),f=n("[data-toggle=events-autocomplete]"),e=n("#ExperienceExplorerPresets"),o=n("#Map"),s=n("#link_testgeo");i.length&&i.Rules();t.length&&(t.hover(function(){n("select").blur()}),t.tooltip());e.length&&e.Presets();r.length&&r.SearchAutocomplete({type:"checkbox"});u.length&&u.SearchAutocomplete({type:"radio"});f.length&&f.SearchAutocomplete({type:"checkbox"});s.length&&s.GeoIp();h.InitMode();setTimeout(function(){if(o.length){var t=n("#GeoLatitude"),i=n("#GeoLongitude");o.MapProvider({latitude:t,longitude:i})}},200)};u.prototype.InitMode=function(){var t=n(".mode-title");n(".mode .btn").click(function(){var i=n(this),r=n(this).siblings();r.removeClass("active");i.addClass("active");t.addClass("hidden");n("[for = "+n(this).attr("id")+"]").removeClass("hidden")})};n.fn[f]=function(t){return this.each(function(){n.data(this,"plugin_"+f)||n.data(this,"plugin_"+f,new u(this,t))})}}(jQuery,window,document);var exp,page,debugging=!1,validationSucceeded=!0,validationErrorMessage="";jQuery(document).ready(function(){exp=new ExpApp;page=new PageModel;page.initialize()});PageModel=function(){var n=this,t;n.initialize=function(){n.setupUi();n.bindModel()};n.getPreset=function(){var n=jQuery("#ExperienceExplorerPresets .item-inner.selected").attr("data-id");exp.model.PresetId=n};n.getCurrentSelectedMode=function(){return jQuery("#ExperienceJourneyMode > .active").attr("data-val")};t=n.getCurrentSelectedMode();n.setupUi=function(){jQuery(".experience-explorer-iframe-editor .btn").button().click(function(n){n.preventDefault()});jQuery("#btn_apply").children(":first").html("Wait...");jQuery("#btn_apply").click(function(){var n=jQuery(this);n.attr("disabled","disabled");n.html(SettingsPanelTranslations.waitText);jQuery(document).trigger("eeEditClick");exp.updateModel()});jQuery("#btn_reset").click(function(){n.getPreset();exp.model.JourneyMode=t;exp.model.Reset=!0;exp.updateModel()})};n.bindModel=function(){jQuery(document).bind("eeEditClick",function(){n.getPreset()});jQuery(document).bind("eeEditClick",function(){var n=jQuery("#ExperienceJourneyMode > .active").attr("data-val");exp.model.JourneyMode=n});jQuery(document).bind("eeEditClick",function(){var n=[],t=jQuery(".profile-block");t.length>0&&(jQuery.each(t,function(t,i){var r=[],u=jQuery(i).attr("data-name"),f=jQuery(i).find("input");jQuery.each(f,function(n,t){var u=jQuery(t).attr("data-name"),i=jQuery(t).val();isNaN(i)||(i.length==0&&(i="0"),r.push({key:u,value:i}))});n.push({name:u,profileKeys:r})}),exp.model.Profiles=n)});jQuery(document).bind("eeEditClick",function(){debugging&&typeof console!="undefined"&&console.log("experience explorer: goals - apply");var n=[],t=jQuery('[data-autocomplete="goals-autocomplete"] input');t.length>0?(exp.model.Goals=[],jQuery(t).each(function(){this.checked&&n.push(this.value)}),exp.model.Goals=n,debugging&&typeof console!="undefined"&&console.log("experience explorer: goals - completed")):debugging&&typeof console!="undefined"&&console.log("experience explorer: goals - no elements found")});jQuery(document).bind("eeEditClick",function(){var n=[],t=jQuery('[data-autocomplete="events-autocomplete"] input');t.length>0&&(exp.model.PageEvents=[],jQuery(t).each(function(){this.checked&&n.push(this.value)}),exp.model.PageEvents=n)});jQuery(document).bind("eeEditClick",function(){debugging&&typeof console!="undefined"&&console.log("experience explorer: device - apply");var n=jQuery("#ExperinceExplorerDevices option:selected");n.length>0?(exp.model.Device=n.val(),debugging&&typeof console!="undefined"&&console.log("experience explorer: device - completed")):debugging&&typeof console!="undefined"&&console.log("experience explorer: device - no elements found")});jQuery(document).bind("eeEditClick",function(){function i(){var n=jQuery(),t=jQuery("#GeoLatitude"),i=jQuery("#GeoLongitude"),r,u;t.length>0&&t.val()!=""&&(r=t.val(),isNaN(r)||(n.latitude=r.replace(",",".")));i.length>0&&i.val()!=""&&(u=i.val(),isNaN(u)||(n.longitude=u.replace(",",".")));exp.model.GeoIp=n}function r(){var t=jQuery(),n=jQuery("#GeoCountryName option:selected");n.length>0&&n.val()!=""&&(t.country=n.val());exp.model.GeoIp=t}function u(){var t=jQuery(),n=jQuery("#GeoIp");n.length>0&&n.val()!=""&&(t.ip=n.val());exp.model.GeoIp=t}function n(n,t){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+n+"=([^&#]*)"),i=r.exec(t);return i==null?"":decodeURIComponent(i[1].replace(/\+/g," "))}function f(){var t=this,i=n("itemUri",location.search),r=n("deviceId",location.search),u=n("visitPageCount",location.search),f=$("input[name=__RequestVerificationToken]",window.parent.document).val();$.ajax({url:"/sitecore/api/ssc/experienceexplorer/contentservice/content/getcontent/?controlId=A504C987889C431394E218B21A5588A8&deviceId="+r+"&itemUri="+encodeURIComponent(i)+"&visitPageCount="+u,type:"GET",dataType:"json",contentType:"application/json",headers:{"X-RequestVerificationToken":f}}).success(function(n){var r,u,i;t.id!=null&&(r=$.templates("#A504C987889C431394E218B21A5588A8_view"),u={itemData:n},r.link("#A504C987889C431394E218B21A5588A8",u),i=jQuery(),i.ip=n.Ip,i.latitude=n.Latitude,i.longitude=n.Longitude,exp.model.GeoIp=i)})}function e(){f()}var t=jQuery(".active[data-toggle=geo-type]").attr("data-source");switch(t){case"#MapArea":i();break;case"#CountryArea":r();break;case"#IpArea":u();break;default:e()}});jQuery(document).bind("eeEditClick",function(){debugging&&typeof console!="undefined"&&console.log("experience explorer: campaigns - apply");var n=[],t=jQuery('[data-autocomplete="campaigns-autocomplete"] input:checked');t.length>0?(jQuery(t).each(function(){n.push(this.value)}),exp.model.Campaigns=n,debugging&&typeof console!="undefined"&&console.log("experience explorer: campaigns - completed")):debugging&&typeof console!="undefined"&&console.log("experience explorer: campaigns - no elements found")});jQuery(document).bind("eeEditClick",function(){debugging&&typeof console!="undefined"&&console.log("experience explorer: referrals - apply");var n=jQuery("#Referral");n.length>0?(n.val()!=""&&(exp.model.Referrer=n.val()),debugging&&typeof console!="undefined"&&console.log("experience explorer: referrals - completed")):debugging&&typeof console!="undefined"&&console.log("experience explorer: referrals - no elements found")})}},function(n){function i(i,u){this.element=i;this.options=n.extend({},r,u);this._defaults=r;this._name=t;this.init()}var t="SearchAutocomplete",r={list:null,type:"checkbox"};i.prototype.init=function(){var t=this,r=n(t.element).attr("data-toggle"),i;t.list=n("[data-autocomplete="+r+"]");i=t.getAutocompleteData();n(t.element).autocomplete({minLength:1,source:i,open:function(){n(this).autocomplete("widget").css({"max-width":270})}}).data("ui-autocomplete")._renderItem=function(i,r){var f=n("<input>").attr("type",t.options.type).attr("id","autocomplete_"+r.id).attr("name",t.options.type+"_group"),s=n("<small>").addClass("tiny-text").text(r.name),u,e,o;return n("#"+r.id).find("input").is(":checked")&&n(f).attr("checked",!0),u=n("<label>").addClass("control").append(f),r.icon&&(e=n("<img>").attr("src",r.icon),u.append(e)),u.append(s),o=n("<li>").append(u),n(f).click(function(){var t=n(this).is(":checked");n("#"+r.id).find("input").prop("checked",t)}),n(o).appendTo(i)}};i.prototype.getAutocompleteData=function(){var i=this,t=[],r=i.list.find(".control");return r.each(function(){var i=n(this),f=i.attr("id"),r=i.find(".listitem-name").text(),e=i.find("input").is(":checked"),u,o;i.find("img").length>0?(o=i.find("img").attr("src"),u={value:r,name:r,id:f,icon:o,selected:e}):u={value:r,name:r,id:f,selected:e};t.push(u)}),t};n.fn[t]=function(r){return this.each(function(){n.data(this,"plugin_"+t)||n.data(this,"plugin_"+t,new i(this,r))})}}(jQuery,window,document);